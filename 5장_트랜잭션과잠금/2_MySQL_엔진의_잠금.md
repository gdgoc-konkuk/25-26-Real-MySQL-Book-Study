## 5.2 MySQL 엔진의 잠금

MySQL 에서 사용되는 잠금의 종류

- **MySQL 엔진 레벨** : MySQL 서버에서 스토리지 엔진을 제외한 나머지 부분. 모든 스토리지 엔진에 영향을 미침
- **스토리지 엔진 레벨** : 스토리지 엔진 간 상호 영향을 미치지는 않음

<br>

### 5.2.1 글로벌 락

> **글로벌 락 : MySQL 에서 제공하는 잠금 중 가장 범위가 큰 락**
> 

**영향 범위**

- MySQL 서버 전체
- 작업 대상 테이블이나 데이터베이스가 다르더라도 동일하게 영향을 미침
- 한 세션에서 글로벌 락을 획득하면, 다른 세션에서 SELECT (조회) 를 제외한 대부분의 DDL 문장이나, DML 문장을 실행하는 경우 글로벌 락이 해제될 때까지 해당 문장이 대기 상태가 됨. 즉 모든 변경 작업을 잠근다고 볼 수 있다.

>[!CAUTION]
> 주의사항
> ---
> 
> - 글로벌 락을 거는 명령 **`(FLUSH TABLES WITH READ LOCK)`** 은 실행과 동시에 MySQL 서버에 존재하는 모든 테이블을 닫고 잠금을 건다.
> 
> - 만약 이 명령이 실행되기 전에 테이블이나 레코드에 쓰기 잠금을 거는 SQL 이 실행됐다면, 이 명령은 해당 테이블에 읽기 잠금을 걸기 위해 먼저 실행된 SQL과 그 트랜잭션이 완료될 때까지 기다려야한다.
> 
> - **`FLUSH TABLES WITH READ LOCK`** 명령은 테이블에 읽기 잠금을 걸기 전에 먼저 테이블을 플러시 해야하기 때문에 테이블에 실행 중인 모든 종류의 쿼리가 완료돼야한다. 따라서 장시간 SELECT 쿼리가 실행되고있을 때, 이 명령은 SELECT 쿼리가 종료될 때까지 기다려야한다.
> 
> - 장시간 실행되는 쿼리와 **`FLUSH TABLES WITH READ LOCK`** 명령이 최악의 케이스로 실행되면, MySQL 서버의 모든 테이블에 대한 INSERT, UPDATE, DELETE 쿼리가 아주 오랜 시간 동안 실행되지 못하고 기다릴 수도 있다.

<br>

### 5.2.2 테이블 락

> **테이블 락 : 개별 테이블 단위로 설정되는 잠금으로써, 명시적 또는 묵시적으로 특정 테이블에 대한 락을 획득할 수 있다.**
> 

**명시적 테이블 락**

- **명시적 테이블 잠금 명령 -** **`LOCK TABLES table_name [ READ | WRITE ]`**
- 명시적 테이블 락 역시도 온라인 작업에 상당한 영향을 미치기 때문에 글로벌 락처럼 특별한 상황이 아니라면 애플리케이션에서 사용할 필요가 없다.

**묵시적 테이블 락**

- MyISAM 이나 MEMORY 테이블에 데이터를 변경하는 쿼리를 실행하면 발생한다.
- 데이터가 변경되는 테이블에 잠금을 설정하고 데이터를 변경한 후, 즉시 잠금을 해제한다. 즉 쿼리가 실행되는 동안 자동으로 락을 획득했다가 쿼리가 완료된 후 자동 해제된다.
- InnoDB 테이블 의 경우 스토리지 엔진 차원에서 레코드 기반의 잠금을 제공하므로 묵시적인 테이블 락이 설정되지는 않는다. 좀 더 정확히는 테이블 락이 설정되긴 하지만, 대부분의 데이터 변경(DML) 쿼리에서는 무시되고 스키마를 변경하는 쿼리(DDL) 의 경우에만 영향을 미친다.

<br>

### 5.2.3 네임드 락

> **네임드 락 : 단순히 사용자가 지정한 문자열(String)에 대해 획득하거나 반납(해제)하는 잠금.**
> 

→ 대상이 테이블이나 레코드와 같은 데이터베이스 객체가 아니다.

데이터베이스 서버 1대에 5대의 웹 서버가 접속해서 서비스하는 상황에서, 여러 대의 웹 서버가 어떤 정보를 동기화해야하는 요건처럼 여러 클라이언트가 상호 동기화를 처리해야할 때 네임드 락을 이용하면 쉽게 처리가 가능하다.

 <br>

### 5.2.4 메타데이터 락

> **메타데이터 락 : 데이터베이스 객체(대표적으로 테이블이나 뷰) 의 이름이나 구조를 변경하는 경우에 획득하는 잠금**
> 

→ 명시적으로 획득하거나 해제할 수 있는 것이 아니다. **`RENAME TABLE tab_a TO tab_b`** 처럼 테이블의 이름을 변경하는 경우 자동으로 획득하는 잠금이다.