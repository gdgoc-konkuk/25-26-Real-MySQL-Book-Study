# 8절. 쿼리 성능 테스트

**11.8 쿼리 성능 테스트**

- 쿼리가 “빠르다/느리다”를 판단하려면 **실행 계획**만 보지 말고, 실제 실행 시에 영향을 주는 환경(캐시, 다른 트래픽 등)을 같이 봐야 함.

---

## 11.8.1 쿼리 성능에 영향을 미치는 요소

### 11.8.1.1 운영체제의 캐시

- OS는 파일을 읽을 때 **파일 시스템 캐시** 에 한 번 올려두고, 다음 읽기부터는 디스크 대신 캐시에서 가져옴.
- 그래서 **한 번 읽은 데이터**는 이후 쿼리에서 훨씬 빠르게 보일 수 있음 → 테스트 시 결과 왜곡.
- InnoDB는 보통 자체 버퍼 풀을 사용해서 OS 캐시 영향이 작지만, **MyISAM은 OS 캐시에 의존도가 커서** OS 캐시 상태에 따라 성능 차이가 큼.

---

### 11.8.1.2 MySQL 서버의 버퍼 풀 / 키 캐시

- MySQL도 자체적으로 **데이터/인덱스 페이지를 캐시**함.
    - InnoDB → 버퍼 풀(Buffer Pool)
    - MyISAM → 키 캐시(Key Cache)
- 한 번 읽으면 버퍼 풀/키 캐시에 올라가서 이후 쿼리는 더 빠르게 수행됨.
- MySQL 8.0에서는 버퍼 풀 내용을 **덤프/로드**하는 기능이 기본 제공됨:
    - `innodb_buffer_pool_dump_at_shutdown`
    - `innodb_buffer_pool_load_at_startup`
- “테스트할 때는 항상 같은 초기 상태에서 시작하고 싶다”면, 이 시스템 변수를 `OFF`로 두고 서버 재시작해서 **버퍼 풀을 미리 채우지 않도록** 만들 수 있음.

---

### 11.8.1.3 독립된 MySQL 서버

- 테스트하는 동안 **다른 웹/배치 프로그램이 같은 MySQL을 쓰고 있다면** 결과가 계속 흔들림.
- 가능하면:
    - 테스트 전용 MySQL 인스턴스에서
    - 동일한 하드웨어 / 동일한 설정으로
    - 클라이언트/네트워크 지연 영향을 최소화한 상태에서 테스트하는 게 좋음.
- 어쩔 수 없이 운영 서버에서 테스트하면, **동시에 실행 중인 다른 쿼리의 영향**을 항상 염두에 둬야 함.

---

### 11.8.1.4 쿼리 테스트 횟수

- 실제 서비스에서는 서버가 충분히 돌아가서 **캐시가 웜업된 상태**인 경우가 많음.

  → “한 번도 안 읽었던 콜드 상태”만 기준으로 보면 실제 서비스와 괴리가 커짐.

- 추천 방법:
    - 같은 쿼리를 **여러 번(6~7회 이상) 반복 실행**해서,
    - 처음 몇 번(캐시 준비 안 된 상태)은 버리고
    - 나머지 실행 시간의 **평균값**을 비교 기준으로 사용.
- 버퍼 풀/키 캐시 용량이 쿼리에 필요한 데이터보다 작으면, **읽기→캐시→버려짐**이 반복되며 실행 시간이 들쭉날쭉해질 수 있으므로, 단 1회 결과만 보고 판단하면 안 됨.