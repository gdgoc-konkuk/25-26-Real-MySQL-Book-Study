# 7장. JSON

MySQL 5.7 버전부터 JSON 타입이 지원되었으며, JSON 데이터를 문자열 그대로 저장하는 것이 아니라 MongoDB와 같은 바이너리 포맷의 BSON(Binary JSON)으로 변환하여 저장한다.

### 15.7.1 저장 방식

### 1. BSON 변환 및 공간 효율

- MySQL 서버는 JSON 컬럼의 값을 내부적으로 **BLOB 타입**에 저장한다.
- JSON 데이터를 문자열(BLOB 또는 TEXT)로 저장하는 것보다 바이너리 포맷(BSON)으로 변환하여 저장하는 것이 **공간 효율이 더 높은 편이다.**
- BSON 포맷은 JSON 문서에서 각 필드의 이름, 순서, 타입, 오프셋(Offset) 등을 바이너리 데이터로 컴팩트하게 저장한다.

```sql
- JSON 문서의 바이너리 길이 확인 예시
SELECT JSON_STORAGE_SIZE('{"a": "x", "b": "y", "c": "z"}') AS binary_length;
-- 결과: 35 바이트 (실제 디스크에 저장되는 크기)
```

### 2. 정규화 컬럼 vs. JSON 컬럼 선택

| **특징** | **정규화된 컬럼 (VARCHAR, INT 등)** | **JSON 컬럼 (doc JSON)** |
| --- | --- | --- |
| **성능** | **SELECT/INSERT/UPDATE 성능 우위.** | 성능상 불리하지만, 낮은 중요도의 속성에 적합. |
| **디스크 효율** | 컬럼 이름이 한 번만 저장되어 효율적. | 레코드마다 필드 이름이 반복 저장되어 비효율적. |
| **메모리 효율** | 레코드별 선택적 접근 및 **Off-Page** 관리가 가능해 효율 우위. | 전체 문서를 읽어야 하므로 메모리 효율이 떨어진다. |
| **활용** | 쿼리가 필요한 데이터만 접근하므로 CPU 효율 우위. | 레코드 전체를 읽어야 쿼리가 가능. |
| **적합성** | 속성이 명확하고 **중요도가 높은** 데이터. | 속성이 다양하고, 자주 접근하지 않으며 **중요도가 낮은** 데이터. |

> 선택 기준: 성능을 최우선으로 고려한다면, 정규화된 컬럼을 사용하는 것이 좋다. JSON 컬럼은 레코드별로 속성이 상이하고 쿼리 접근 빈도가 낮은 경우에 비정규화된 형태로 데이터를 저장하는 이점이 있다.
>

### 15.7.2 부분 업데이트 성능 (Partial Update)

MySQL 8.0 버전부터 JSON 타입에 대해 **부분 업데이트(Partial Update)** 기능이 도입되어 성능 개선이 이루어졌다.

### 1. 부분 업데이트 작동 원리

- `JSON_SET()`, `JSON_REPLACE()`, `JSON_REMOVE()` 함수 등을 사용하여 JSON 문서의 특정 필드 값만 변경하는 기능이다.

### 2. 성능 최적화 옵션 (Replication 환경)

복제(Replication) 환경에서 부분 업데이트의 성능을 최대한 끌어올리기 위해 다음 시스템 변수를 조정할 수 있다.

| **변수** | **설정 값** | **설명** |
| --- | --- | --- |
| `binlog_row_value_options` | `PARTIAL_JSON` | 바이너리 로그에 변경된 JSON 부분만 기록하도록 설정. |
| `binlog_row_image` | `MINIMAL` | 바이너리 로그에 레코드의 모든 컬럼 대신 최소한의 데이터만 기록하도록 설정. |
| `binlog_format` | `STATEMENT` | UPDATE 문 자체를 기록하여 성능을 개선하는 방식. |

> 주의: 부분 업데이트 최적화를 적용하려면 JSON 컬럼을 가진 테이블에 PRIMARY KEY가 필수적이다. PK가 없으면 복제 시 레코드 전체를 바이너리 로그에 기록해야 한다.
>

### 15.7.4 JSON 컬럼 vs. BLOB / TEXT 컬럼

- **TEXT/BLOB:** 입력된 JSON 문자열을 그대로 디스크에 저장한다.
- **JSON 타입:**
    1. JSON 데이터를 바이너리 포맷(BSON)으로 압축하여 저장하므로 공간 효율이 좋다.
    2. `JSON_SET`, `JSON_REMOVE` 등을 통한 **빠른 부분 변경 기능**을 제공한다.
    3. JSON 데이터 가공에 필요한 다양한 내장 함수를 제공한다.

> 결론: JSON 데이터를 저장할 목적이라면, 단순히 문자열을 담는 BLOB이나 TEXT보다는 JSON 타입 컬럼을 선택하는 것이 기능적, 효율적 측면에서 더 유리하다.
>

---

- MySQL 데이터베이스 설계에서 **성능을 최우선**으로 한다면, JSON 컬럼보다는 정규화된 컬럼(VARCHAR, INT 등)을 사용하는 것이 권장

**JSON 컬럼이 적합한 경우**

- **속성이 다양함:** 레코드마다 가지고 있는 속성이 다르거나(Schemaless), 속성의 개수가 매우 많을 때.
- **접근 빈도가 낮음:** 핵심 데이터가 아니며, 쿼리로 자주 조회되거나 업데이트되지 않는 낮은 중요도의 속성(예: 로그, 기타 설정값 등)을 저장할 때.
- **비정규화 이점:** 개발자가 애플리케이션 코드에서 처리하기 편하도록 비정규화된 형태로 데이터를 저장할 때.